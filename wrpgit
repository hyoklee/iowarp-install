#!/usr/bin/env python3

import os
import sys
import git
import yaml
import shutil
from pathlib import Path
from jarvis_util.shell.exec import Exec
from jarvis_util.shell.local_exec import LocalExecInfo
from jarvis_util import ColorPrinter, Color
from jarvis_util.util.argparse import ArgParse

class WrpPrinter(ColorPrinter):
    @staticmethod
    def print_info(message: str):
        ColorPrinter.print(message, Color.BLUE)

    @staticmethod
    def print_warn(message: str):
        ColorPrinter.print(message, Color.YELLOW)

    @staticmethod
    def print_error(message: str):
        ColorPrinter.print(message, Color.RED)

    @staticmethod
    def print_ok(message: str):
        ColorPrinter.print(message, Color.GREEN)

class GitUrl:
    """Class to handle GitHub URLs for both HTTPS and SSH access"""
    def __init__(self, username: str, package_name: str):
        if username == 'iowarp' and package_name == 'scspkg':
            username = 'grc-iit'
        self.url_https = f"https://github.com/{username}/{package_name}.git"
        self.url_ssh = f"git@github.com:{username}/{package_name}.git"

    def get_url(self, protocol: str) -> str:
        """Get the URL for the specified protocol.
        Args:
            protocol: Either 'ssh' or 'https'
        Returns:
            The URL string for the specified protocol
        """
        return self.url_ssh if protocol == 'ssh' else self.url_https

class WrpGit:
    def __init__(self):
        self.script_dir = Path(__file__).parent
        self.iowarp_dir = self.check_iowarp_env()
        self.config_path = self.script_dir / 'wrpgit.yaml'
        self.default_config_path = self.script_dir / 'wrpgit-default.yaml'
        self.config = None

    def check_iowarp_env(self) -> Path:
        """Check if IOWARP environment variable is set and valid"""
        iowarp_dir = os.getenv('IOWARP')
        if not iowarp_dir:
            WrpPrinter.print_error("IOWARP environment variable is not set")
            sys.exit(1)
        return Path(iowarp_dir)

    def check_clone_marker(self):
        """Check if .wrpgit marker exists"""
        marker = self.iowarp_dir / '.wrpgit'
        if not marker.exists():
            WrpPrinter.print_error(f"{marker} does not exist. Did you run 'wrpgit clone' first?")
            sys.exit(1)

    def check_config(self):
        """Check if config exists and load it"""
        if not self.config_path.exists():
            WrpPrinter.print_error(f"Configuration file {self.config_path} does not exist. Run 'wrpgit init' first.")
            sys.exit(1)
        try:
            with open(self.config_path) as f:
                self.config = yaml.safe_load(f)
        except Exception as e:
            WrpPrinter.print_error(f"Error loading configuration: {str(e)}")
            sys.exit(1)

    def init(self):
        """Initialize wrpgit configuration"""
        if self.config_path.exists():
            WrpPrinter.print_warn(f"Configuration file {self.config_path} already exists, skipping...")
            return
        
        if not self.default_config_path.exists():
            WrpPrinter.print_error(f"Default configuration file {self.default_config_path} not found")
            sys.exit(1)

        try:
            WrpPrinter.print_info(f"Creating configuration file {self.config_path}")
            shutil.copy2(self.default_config_path, self.config_path)
            WrpPrinter.print_ok("Successfully created configuration file")
        except Exception as e:
            WrpPrinter.print_error(f"Error creating configuration file: {str(e)}")
            sys.exit(1)

    def save_config(self):
        """Save current configuration to YAML file"""
        with open(self.config_path, 'w') as f:
            yaml.dump(self.config, f)

    def clone(self):
        """Clone all repositories"""
        self.check_config()
        WrpPrinter.print_info(f"Creating directory {self.iowarp_dir}")
        self.iowarp_dir.mkdir(parents=True, exist_ok=True)
        (self.iowarp_dir / '.wrpgit').touch()

        # Save config if it doesn't exist
        if not self.config_path.exists():
            self.save_config()

        # Validate protocol
        if self.config.get('protocol', 'https') not in ['https', 'ssh']:
            WrpPrinter.print_error(f"Invalid protocol {self.config.get('protocol')}, must be 'https' or 'ssh'")
            sys.exit(1)

        for module in self.config['modules']:
            pkg_name = module['name']
            target_dir = self.iowarp_dir / pkg_name
            if target_dir.exists():
                WrpPrinter.print_warn(f"Directory {target_dir} already exists, skipping...")
                continue

            WrpPrinter.print_info(f"Attempting to clone {pkg_name}...")
            
            # Determine which URLs to use based on fork setting
            if module.get('fork', False):
                # For forked repos, try user's URL first
                urls = GitUrl(self.config['username'], pkg_name)
                url = urls.get_url(self.config['protocol'])
                WrpPrinter.print_info(f"Repository marked for fork, trying {self.config['protocol'].upper()} URL: {url}")
                
                try:
                    git.Repo.clone_from(url, target_dir)
                    WrpPrinter.print_ok(f"Successfully cloned {pkg_name} from {self.config['username']}")
                except git.exc.GitCommandError as e:
                    WrpPrinter.print_error(f"Failed to clone {pkg_name} from {self.config['username']}: {str(e)}")
                    sys.exit(1)
            else:
                # For non-forked repos, try iowarp URL
                urls = GitUrl('iowarp', pkg_name)
                url = urls.get_url(self.config['protocol'])
                WrpPrinter.print_info(f"Trying {self.config['protocol'].upper()} URL: {url}")
                
                try:
                    git.Repo.clone_from(url, target_dir)
                    WrpPrinter.print_ok(f"Successfully cloned {pkg_name} from iowarp")
                except git.exc.GitCommandError as e:
                    WrpPrinter.print_error(f"Failed to clone {pkg_name} from iowarp: {str(e)}")
                    sys.exit(1)

    def add_remote(self, repo_dir: Path, username: str, alias: str = None):
        """Add a git remote to a repository"""
        if alias is None:
            alias = username
            
        try:
            repo = git.Repo(repo_dir)
            if alias in repo.remotes:
                WrpPrinter.print_warn(f"Remote {alias} already exists in {repo_dir.name}, skipping...")
                return
                
            if username == 'iowarp' and repo_dir.name == 'scspkg':
                username = 'grc-iit'
            
            # Use protocol from config
            if self.config.get('protocol', 'https') not in ['https', 'ssh']:
                WrpPrinter.print_warn(f"Invalid protocol {self.config.get('protocol')}, defaulting to https")
                self.config['protocol'] = 'https'
            
            urls = GitUrl(username, repo_dir.name)
            url = urls.get_url(self.config['protocol'])
            repo.create_remote(alias, url)
            WrpPrinter.print_ok(f"Added remote {alias} ({url}) to {repo_dir.name}")
        except git.exc.InvalidGitRepositoryError:
            WrpPrinter.print_warn(f"{repo_dir} is not a git repository")
        except Exception as e:
            WrpPrinter.print_error(f"Error adding remote to {repo_dir}: {str(e)}")

    def pull(self):
        """Pull updates for all repositories"""
        self.check_clone_marker()
        self.check_config()
        
        for repo_dir in self.iowarp_dir.iterdir():
            if not repo_dir.is_dir() or repo_dir.name.startswith('.'):
                continue
            
            try:
                WrpPrinter.print_info(f"Pulling updates for {repo_dir.name}...")
                cmd = ['git', 'pull']
                Exec(' '.join(cmd), LocalExecInfo(cwd=str(repo_dir)))
                WrpPrinter.print_ok(f"Successfully pulled {repo_dir.name}")
            except Exception as e:
                WrpPrinter.print_error(f"Error pulling {repo_dir}: {str(e)}")

    def setup(self):
        """Setup the environment"""
        self.check_clone_marker()
        self.check_config()
        home_dir = str(Path.home())
        
        # First create scspkg modules
        WrpPrinter.print_info("Creating scspkg modules...")
        for module in self.config['modules']:
            repo_dir = self.iowarp_dir / module['name']
            if not repo_dir.is_dir():
                continue
                
            try:
                WrpPrinter.print_info(f"Creating scspkg module for {module['name']}...")
                Exec(f"scspkg create {module['name']}", LocalExecInfo(cwd=str(self.iowarp_dir)))
                if 'depends_on' in module:
                    Exec(f"scspkg dep add {module['name']} {module['depends_on']}", LocalExecInfo(cwd=str(self.iowarp_dir)))
                WrpPrinter.print_ok(f"Successfully created scspkg module for {module['name']}")
            except Exception as e:
                WrpPrinter.print_error(f"Error creating scspkg module for {module['name']}: {str(e)}")
                sys.exit(1)
        
        # Then handle CMakePresets.json
        for module in self.config['modules']:
            if module['type'] != 'cmake':
                continue
                
            repo_dir = self.iowarp_dir / module['name']
            vscode_dir = repo_dir / '.vscode'
            presets_file = vscode_dir / 'CMakePresets.json'
            if vscode_dir.exists() and presets_file.exists():
                WrpPrinter.print_info(f"Configuring CMakePresets.json for {module['name']}...")
                with open(presets_file, 'r') as f:
                    content = f.read().replace('IOWARP_PREFIX', f'{home_dir}/.scspkg/packages/{module["name"]}')
                
                with open(repo_dir / 'CMakePresets.json', 'w') as f:
                    f.write(content)
                WrpPrinter.print_ok(f"Successfully configured CMakePresets.json for {module['name']}")
            else:
                WrpPrinter.print_warn(f"No .vscode directory found in {module['name']}, skipping...")
        
        self.env()

    def env(self):
        """Source environment files"""
        self.check_clone_marker()
        self.check_config()
        
        for module in self.config['modules']:
            repo_dir = self.iowarp_dir / module['name']
            if not repo_dir.is_dir():
                continue

            try:
                WrpPrinter.print_info(f"Creating env.sh for {module['name']}...")
                env_file = repo_dir / 'env.sh'
                with open(env_file, 'w') as f:
                    if 'depends_on' in module:
                        f.write(f"module load {module['depends_on']}\n")
                    f.write("scspkg build profile m=cmake path=.env.cmake\n")
                    f.write("scspkg build profile m=dotenv path=.env\n")

                WrpPrinter.print_info(f"Sourcing env.sh in {module['name']}...")
                Exec(f"bash {env_file}", LocalExecInfo(cwd=str(repo_dir)))
                WrpPrinter.print_ok(f"Successfully sourced env.sh in {module['name']}")
            except Exception as e:
                WrpPrinter.print_error(f"Error sourcing env.sh in {module['name']}: {str(e)}")

    def build(self):
        """Build and install all repositories"""
        self.check_clone_marker()
        self.check_config()
        
        for module in self.config['modules']:
            if not module['build']:
                continue

            repo_dir = self.iowarp_dir / module['name']
            if module['type'] == 'cmake':
                cmake_file = repo_dir / 'CMakeLists.txt'
                presets_file = repo_dir / 'CMakePresets.json'
                if cmake_file.exists() and presets_file.exists():
                    build_dir = repo_dir / 'build'
                    WrpPrinter.print_info(f"Building {module['name']}...")
                    build_dir.mkdir(exist_ok=True)
                    
                    cmd = ['cmake', '..']
                    if module['preset']:
                        cmd.extend(['--preset', module['preset']])
                    
                    try:
                        WrpPrinter.print_info(f"Running CMake for {module['name']}...")
                        node = Exec(' '.join(cmd), LocalExecInfo(cwd=str(build_dir)))
                        if node.exit_code != 0:
                            raise Exception(f"CMake configure failed with exit code {node.exit_code}")
                            
                        WrpPrinter.print_info(f"Building {module['name']}...")
                        node = Exec('cmake --build .', LocalExecInfo(cwd=str(build_dir)))
                        if node.exit_code != 0:
                            raise Exception(f"CMake build failed with exit code {node.exit_code}")
                            
                        WrpPrinter.print_info(f"Installing {module['name']}...")
                        node = Exec('cmake --install .', LocalExecInfo(cwd=str(build_dir)))
                        if node.exit_code != 0:
                            raise Exception(f"CMake install failed with exit code {node.exit_code}")
                            
                        WrpPrinter.print_ok(f"Successfully built and installed {module['name']}")
                    except Exception as e:
                        WrpPrinter.print_error(f"Error building/installing {module['name']}: {str(e)}")
                        sys.exit(1)
            elif module['type'] == 'python':
                try:
                    WrpPrinter.print_info(f"Building {module['name']}...")
                    req_file = repo_dir / 'requirements.txt'
                    if req_file.exists():
                        node = Exec('pip install -r requirements.txt', LocalExecInfo(cwd=str(repo_dir)))
                        if node.exit_code != 0:
                            raise Exception(f"pip install requirements failed with exit code {node.exit_code}")
                            
                    node = Exec('pip install -e .', LocalExecInfo(cwd=str(repo_dir)))
                    if node.exit_code != 0:
                        raise Exception(f"pip install package failed with exit code {node.exit_code}")
                        
                    WrpPrinter.print_ok(f"Successfully built {module['name']}")
                except Exception as e:
                    WrpPrinter.print_error(f"Error building {module['name']}: {str(e)}")
                    sys.exit(1)

    def install(self):
        """Install all repositories"""
        self.check_clone_marker()
        self.check_config()
        
        for module in self.config['modules']:
            if module['type'] != 'cmake':
                continue

            repo_dir = self.iowarp_dir / module['name']
            build_dir = repo_dir / 'build'
            if build_dir.exists():
                WrpPrinter.print_info(f"Installing {module['name']}...")
                cmd = ['cmake', '--install', '.']
                if module['preset']:
                    cmd.extend(['--preset', module['preset']])
                
                try:
                    Exec(' '.join(cmd), LocalExecInfo(cwd=str(build_dir)))
                    WrpPrinter.print_ok(f"Successfully installed {module['name']}")
                except Exception as e:
                    WrpPrinter.print_error(f"Error installing {module['name']}: {str(e)}")

    def clean(self):
        """Clean all build directories"""
        self.check_clone_marker()
        self.check_config()
        
        for module in self.config['modules']:
            if module['type'] != 'cmake':
                continue

            repo_dir = self.iowarp_dir / module['name']
            build_dir = repo_dir / 'build'
            if build_dir.exists():
                try:
                    WrpPrinter.print_info(f"Cleaning build directory for {module['name']}...")
                    shutil.rmtree(build_dir)
                    WrpPrinter.print_ok(f"Successfully cleaned build directory for {module['name']}")
                except Exception as e:
                    WrpPrinter.print_error(f"Error cleaning build directory for {module['name']}: {str(e)}")

    def fork(self):
        """Fork repositories marked for forking using GitHub CLI"""
        self.check_clone_marker()
        self.check_config()
        
        for module in self.config['modules']:
            if not module.get('fork', False):
                continue
                
            pkg_name = module['name']
            WrpPrinter.print_info(f"Attempting to fork {pkg_name}...")
            
            try:
                # Use GitUrl to construct the repository URL
                urls = GitUrl('iowarp', pkg_name)
                # Extract owner/repo from the HTTPS URL
                repo = urls.url_https.split('github.com/')[1].replace('.git', '')
                
                # Use GitHub CLI to fork the repository
                node = Exec(f"gh repo fork {repo} --clone=false", LocalExecInfo(cwd=str(self.iowarp_dir)))
                if node.exit_code != 0:
                    raise Exception(f"GitHub fork failed with exit code {node.exit_code}")
                    
                WrpPrinter.print_ok(f"Successfully forked {pkg_name}")
            except Exception as e:
                WrpPrinter.print_error(f"Error forking {pkg_name}: {str(e)}")
                continue

class WrpGitArgParser(ArgParse):
    def __init__(self):
        super().__init__()
        self.script_dir = Path(__file__).parent

    def define_options(self):
        # Init command
        self.add_cmd('init')
        self.add_args([])

        # Clone command
        self.add_cmd('clone')
        self.add_args([])

        # Pull command
        self.add_cmd('pull')
        self.add_args([])

        # Setup command
        self.add_cmd('setup')
        self.add_args([])

        # Env command
        self.add_cmd('env')
        self.add_args([])

        # Build command
        self.add_cmd('build')
        self.add_args([])

        # Install command
        self.add_cmd('install')
        self.add_args([])

        # Clean command
        self.add_cmd('clean')
        self.add_args([])

        # Fork command
        self.add_cmd('fork')
        self.add_args([])

    def init(self):
        wrpgit = WrpGit()
        wrpgit.init()

    def clone(self):
        wrpgit = WrpGit()
        wrpgit.clone()

    def pull(self):
        wrpgit = WrpGit()
        wrpgit.pull()

    def setup(self):
        wrpgit = WrpGit()
        wrpgit.setup()

    def env(self):
        wrpgit = WrpGit()
        wrpgit.env()

    def build(self):
        wrpgit = WrpGit()
        wrpgit.build()

    def install(self):
        wrpgit = WrpGit()
        wrpgit.install()

    def clean(self):
        wrpgit = WrpGit()
        wrpgit.clean()

    def fork(self):
        wrpgit = WrpGit()
        wrpgit.fork()

def main():
    args = WrpGitArgParser()
    args.process_args()

if __name__ == '__main__':
    main() 